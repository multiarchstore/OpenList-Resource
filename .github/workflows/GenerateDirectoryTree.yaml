name: Generate Directory Tree

on:
  push:
    branches:
      - main  # ä¸»åˆ†æ”¯

permissions:
  contents: write
jobs:
  generate-tree:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ä»“åº“å†å²

      - name: Generate directory tree
        run: |
          # å®‰è£…treeå‘½ä»¤
          sudo apt-get install tree -y
          
          # åˆ›å»ºç”Ÿæˆç›®å½•æ ‘çš„è„šæœ¬
          cat > generate_trees.sh << 'EOF'
          #!/bin/bash
          
          # æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶å¤¹ï¼Œæ’é™¤ç‰¹å®šç›®å½•
          find . -type d \( ! -path "*/.git/*" -a ! -path "*/.github/*" -a ! -path "*/.vscode/*" \) | while read -r dir; do
              # æ’é™¤é¡¶çº§éšè—ç›®å½•
              if [[ "$dir" == "./.git" || "$dir" == "./.github" || "$dir" == "./.vscode" ]]; then
                  continue
              fi
              
              # è¿›å…¥ç›®å½•
              cd "$dir" || continue
              
              # ç”Ÿæˆç›®å½•æ ‘å¹¶ä¿å­˜åˆ°index.htmlï¼Œæ’é™¤å·²æœ‰çš„index.htmlå’Œéšè—ç›®å½•
              tree -H . -L 2 -o index.html --charset=UTF-8 --ignore-case -I "index.html|.git|.github|.vscode|generate_trees.sh" .
              # å°† `<a href="./">.</a>` æ›¿æ¢ä¸º `<a href="../">ğŸ‘† å›åˆ°ä¸Šä¸€çº§ç›®å½•</a>`
              sed -i 's|<a href="./">.</a>|<a href="../">ğŸ‘† å›åˆ°ä¸Šä¸€çº§ç›®å½•</a>|g' index.html
              # æ·»åŠ è‡ªå®šä¹‰æ ·å¼
              echo '<style>body { font-family: Arial, sans-serif; } .tree { margin: 20px; } .tree ul { list-style-type: none; margin-left: 20px; padding-left: 1em; position: relative; } .tree ul ul::before { content: ""; display: block; position: absolute; left: 0; top: 0; bottom: 0; width: 1px; background-color: #ccc; } .tree li { margin: 5px 0; padding-left: 1.5em; position: relative; } .tree li::before { content: ""; display: block; position: absolute; left: 0; top: 0.7em; width: 10px; height: 1px; background-color: #ccc; } .tree a { color: #0366d6; text-decoration: none; } .tree a:hover { text-decoration: underline; } .back-link { font-weight: bold; color: #0366d6; }</style>' >> index.html
              
              # è¿”å›ä¸Šä¸€çº§ç›®å½•
              cd - > /dev/null
          done
          EOF
          
          # æ‰§è¡Œè„šæœ¬ç”Ÿæˆæ‰€æœ‰ç›®å½•æ ‘
          chmod +x generate_trees.sh
          ./generate_trees.sh
          # å°†ç”Ÿæˆçš„index.html `<a href="../">ğŸ‘† å›åˆ°ä¸Šä¸€çº§ç›®å½•</a>` æ›¿æ¢ä¸º `<a href="./">.</a>`
          sed -i 's|<a href="../">ğŸ‘† å›åˆ°ä¸Šä¸€çº§ç›®å½•</a>|<a href="./">.</a>|g' index.html
          # åˆ é™¤è„šæœ¬æ–‡ä»¶
          rm generate_trees.sh

      - name: Commit and push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          # æ‹‰å–è¿œç¨‹æœ€æ–°ä»£ç å¹¶rebaseï¼Œç¡®ä¿æœ¬åœ°ä¸è¿œç¨‹åŒæ­¥
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "Update directory trees"
            git pull --rebase origin main
            # æ¨é€æ—¶è‹¥æœ‰å†²çªï¼Œè‡ªåŠ¨å°è¯•rebaseè§£å†³ï¼ˆéœ€ç¡®ä¿æ— æ‰‹åŠ¨å†²çªï¼‰
            git push --force-with-lease origin main
          else
            echo "No changes to commit"
          fi
